{"ast":null,"code":"import { Observable, throwError } from 'rxjs';\nimport { catchError, map, switchMap } from 'rxjs/operators';\nimport { environment } from '../../environments/environment';\nimport * as i0 from \"@angular/core\";\nimport * as i1 from \"@angular/common/http\";\nimport * as i2 from \"./subject.service\";\nimport * as i3 from \"./auth.service\";\nexport class RegistrationService {\n  constructor(http, subjectService, authService) {\n    this.http = http;\n    this.subjectService = subjectService;\n    this.authService = authService;\n    this.apiUrl = `${environment.apiUrl}/Registros`;\n    this.MAX_SUBJECTS = 3;\n  }\n  getStudentRegistrations(studentId) {\n    return this.http.get(`${this.apiUrl}/student/${studentId}`).pipe(catchError(this.handleError));\n  }\n  getSubjectRegistrations(subjectId) {\n    return this.http.get(`${this.apiUrl}/subject/${subjectId}`).pipe(catchError(this.handleError));\n  }\n  getRegistration(id) {\n    return this.http.get(`${this.apiUrl}/${id}`).pipe(catchError(this.handleError));\n  }\n  registerSubject(request) {\n    const studentId = request.studentId;\n    // Check if student already has 3 subjects\n    return this.getStudentRegistrations(studentId).pipe(switchMap(registrations => {\n      if (registrations.length >= this.MAX_SUBJECTS) {\n        return throwError(() => new Error('No puedes registrar más de 3 materias'));\n      }\n      // Get the professors of the subjects the student is already registered for\n      const registeredSubjectIds = registrations.map(r => r.subjectId);\n      if (registeredSubjectIds.includes(request.subjectId)) {\n        return throwError(() => new Error('Ya estás registrado en esta materia'));\n      }\n      // If student has no registrations yet, proceed with registration\n      if (registeredSubjectIds.length === 0) {\n        return this.http.post(this.apiUrl, request).pipe(catchError(this.handleError));\n      }\n      // Get the subject details to check professor\n      return this.subjectService.getSubject(request.subjectId).pipe(switchMap(newSubject => {\n        // Get all subjects the student is registered for\n        return this.subjectService.getSubjectsByIds(registeredSubjectIds).pipe(switchMap(registeredSubjects => {\n          // Check if the new subject's professor is already teaching the student\n          const professorIds = registeredSubjects.map(s => s.professorId);\n          if (professorIds.includes(newSubject.professorId)) {\n            return throwError(() => new Error('No puedes tener más de una materia con el mismo profesor'));\n          }\n          // All checks passed, proceed with registration\n          return this.http.post(this.apiUrl, request).pipe(catchError(this.handleError));\n        }));\n      }));\n    }));\n  }\n  unregisterSubject(id) {\n    return this.http.delete(`${this.apiUrl}/${id}`).pipe(catchError(this.handleError));\n  }\n  getClassmates(subjectId, currentStudentId) {\n    return this.getSubjectRegistrations(subjectId).pipe(map(registrations => {\n      // Filter out the current student and extract only the names\n      return registrations.filter(reg => reg.studentId !== currentStudentId && reg.student).map(reg => reg.student.name);\n    }), catchError(this.handleError));\n  }\n  // Get total credits for a student\n  getStudentTotalCredits(studentId) {\n    return this.getStudentRegistrations(studentId).pipe(switchMap(registrations => {\n      if (registrations.length === 0) {\n        return new Observable(observer => {\n          observer.next(0);\n          observer.complete();\n        });\n      }\n      const subjectIds = registrations.map(r => r.subjectId);\n      return this.subjectService.getSubjectsByIds(subjectIds).pipe(map(subjects => {\n        return subjects.reduce((total, subject) => total + subject.credits, 0);\n      }));\n    }), catchError(this.handleError));\n  }\n  handleError(error) {\n    let errorMessage = 'An unknown error occurred!';\n    if (error.error instanceof ErrorEvent) {\n      // Client-side error\n      errorMessage = `Error: ${error.error.message}`;\n    } else if (error.error && error.error.message) {\n      // Server-side error with message\n      errorMessage = error.error.message;\n    } else if (error.message) {\n      // Custom error message\n      errorMessage = error.message;\n    } else if (error.status) {\n      // HTTP error\n      errorMessage = `Error ${error.status}: ${error.statusText}`;\n    }\n    return throwError(() => new Error(errorMessage));\n  }\n  static {\n    this.ɵfac = function RegistrationService_Factory(t) {\n      return new (t || RegistrationService)(i0.ɵɵinject(i1.HttpClient), i0.ɵɵinject(i2.SubjectService), i0.ɵɵinject(i3.AuthService));\n    };\n  }\n  static {\n    this.ɵprov = /*@__PURE__*/i0.ɵɵdefineInjectable({\n      token: RegistrationService,\n      factory: RegistrationService.ɵfac,\n      providedIn: 'root'\n    });\n  }\n}","map":{"version":3,"mappings":"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","names":["Observable","throwError","catchError","map","switchMap","environment","RegistrationService","constructor","http","subjectService","authService","apiUrl","getStudentRegistrations","studentId","get","pipe","handleError","getSubjectRegistrations","subjectId","getRegistration","id","registerSubject","request","registrations","length","MAX_SUBJECTS","Error","registeredSubjectIds","r","includes","post","getSubject","newSubject","getSubjectsByIds","registeredSubjects","professorIds","s","professorId","unregisterSubject","delete","getClassmates","currentStudentId","filter","reg","student","name","getStudentTotalCredits","observer","next","complete","subjectIds","subjects","reduce","total","subject","credits","error","errorMessage","ErrorEvent","message","status","statusText","factory","providedIn"],"sourceRoot":"","sources":["C:\\Users\\hansk\\Videos\\Prueba interrapidisimp\\frontend\\src\\app\\services\\registration.service.ts"],"sourcesContent":["import { Injectable } from '@angular/core';\nimport { HttpClient } from '@angular/common/http';\nimport { Observable, throwError, forkJoin } from 'rxjs';\nimport { catchError, map, switchMap } from 'rxjs/operators';\nimport { Registration, RegistrationRequest } from '../models/registration.model';\nimport { Subject } from '../models/subject.model';\nimport { SubjectService } from './subject.service';\nimport { AuthService } from './auth.service';\nimport { environment } from '../../environments/environment';\n\n@Injectable({\n  providedIn: 'root'\n})\nexport class RegistrationService {\n  private apiUrl = `${environment.apiUrl}/Registros`;\n  private MAX_SUBJECTS = 3;\n\n  constructor(\n    private http: HttpClient, \n    private subjectService: SubjectService,\n    private authService: AuthService\n  ) { }\n\n  getStudentRegistrations(studentId: number): Observable<Registration[]> {\n    return this.http.get<Registration[]>(`${this.apiUrl}/student/${studentId}`)\n      .pipe(catchError(this.handleError));\n  }\n\n  getSubjectRegistrations(subjectId: number): Observable<Registration[]> {\n    return this.http.get<Registration[]>(`${this.apiUrl}/subject/${subjectId}`)\n      .pipe(catchError(this.handleError));\n  }\n\n  getRegistration(id: number): Observable<Registration> {\n    return this.http.get<Registration>(`${this.apiUrl}/${id}`)\n      .pipe(catchError(this.handleError));\n  }\n\n  registerSubject(request: RegistrationRequest): Observable<Registration> {\n    const studentId = request.studentId;\n    \n    // Check if student already has 3 subjects\n    return this.getStudentRegistrations(studentId).pipe(\n      switchMap(registrations => {\n        if (registrations.length >= this.MAX_SUBJECTS) {\n          return throwError(() => new Error('No puedes registrar más de 3 materias'));\n        }\n        \n        // Get the professors of the subjects the student is already registered for\n        const registeredSubjectIds = registrations.map(r => r.subjectId);\n        \n        if (registeredSubjectIds.includes(request.subjectId)) {\n          return throwError(() => new Error('Ya estás registrado en esta materia'));\n        }\n        \n        // If student has no registrations yet, proceed with registration\n        if (registeredSubjectIds.length === 0) {\n          return this.http.post<Registration>(this.apiUrl, request)\n            .pipe(catchError(this.handleError));\n        }\n        \n        // Get the subject details to check professor\n        return this.subjectService.getSubject(request.subjectId).pipe(\n          switchMap(newSubject => {\n            // Get all subjects the student is registered for\n            return this.subjectService.getSubjectsByIds(registeredSubjectIds).pipe(\n              switchMap(registeredSubjects => {\n                // Check if the new subject's professor is already teaching the student\n                const professorIds = registeredSubjects.map(s => s.professorId);\n                \n                if (professorIds.includes(newSubject.professorId)) {\n                  return throwError(() => new Error('No puedes tener más de una materia con el mismo profesor'));\n                }\n                \n                // All checks passed, proceed with registration\n                return this.http.post<Registration>(this.apiUrl, request)\n                  .pipe(catchError(this.handleError));\n              })\n            );\n          })\n        );\n      })\n    );\n  }\n\n  unregisterSubject(id: number): Observable<any> {\n    return this.http.delete(`${this.apiUrl}/${id}`)\n      .pipe(catchError(this.handleError));\n  }\n\n  getClassmates(subjectId: number, currentStudentId: number): Observable<string[]> {\n    return this.getSubjectRegistrations(subjectId).pipe(\n      map(registrations => {\n        // Filter out the current student and extract only the names\n        return registrations\n          .filter(reg => reg.studentId !== currentStudentId && reg.student)\n          .map(reg => reg.student!.name);\n      }),\n      catchError(this.handleError)\n    );\n  }\n\n  // Get total credits for a student\n  getStudentTotalCredits(studentId: number): Observable<number> {\n    return this.getStudentRegistrations(studentId).pipe(\n      switchMap(registrations => {\n        if (registrations.length === 0) {\n          return new Observable<number>(observer => {\n            observer.next(0);\n            observer.complete();\n          });\n        }\n        \n        const subjectIds = registrations.map(r => r.subjectId);\n        return this.subjectService.getSubjectsByIds(subjectIds).pipe(\n          map(subjects => {\n            return subjects.reduce((total, subject) => total + subject.credits, 0);\n          })\n        );\n      }),\n      catchError(this.handleError)\n    );\n  }\n\n  private handleError(error: any) {\n    let errorMessage = 'An unknown error occurred!';\n    if (error.error instanceof ErrorEvent) {\n      // Client-side error\n      errorMessage = `Error: ${error.error.message}`;\n    } else if (error.error && error.error.message) {\n      // Server-side error with message\n      errorMessage = error.error.message;\n    } else if (error.message) {\n      // Custom error message\n      errorMessage = error.message;\n    } else if (error.status) {\n      // HTTP error\n      errorMessage = `Error ${error.status}: ${error.statusText}`;\n    }\n    return throwError(() => new Error(errorMessage));\n  }\n}"]},"metadata":{},"sourceType":"module","externalDependencies":[]}