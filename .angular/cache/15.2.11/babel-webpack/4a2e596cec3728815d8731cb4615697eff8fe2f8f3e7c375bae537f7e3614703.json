{"ast":null,"code":"import { throwError, of } from 'rxjs';\nimport { catchError, map, switchMap } from 'rxjs/operators';\nimport { environment } from '../../environments/environment';\nimport * as i0 from \"@angular/core\";\nimport * as i1 from \"@angular/common/http\";\nimport * as i2 from \"./asignatura.servicio\";\nimport * as i3 from \"./autenticacion.servicio\";\nexport class InscripcionServicio {\n  constructor(http, asignaturaServicio, autenticacionServicio) {\n    this.http = http;\n    this.asignaturaServicio = asignaturaServicio;\n    this.autenticacionServicio = autenticacionServicio;\n    this.apiUrl = `${environment.apiUrl}/Registros`;\n    this.MAX_ASIGNATURAS = 3;\n  }\n  obtenerInscripcionesEstudiante(estudianteId) {\n    console.log(estudianteId);\n    return this.http.get(`${this.apiUrl}/estudiante/${estudianteId}`).pipe(map(respuesta => {\n      if (respuesta && respuesta.exito && respuesta.data) {\n        console.log('Procesando inscripciones del estudiante:', respuesta.data);\n        return respuesta.data.map(item => ({\n          id: item.id,\n          estudianteId: item.estudianteId,\n          asignaturaId: item.materiaId,\n          fechaInscripcion: new Date(item.fechaRegistro),\n          estudiante: item.nombreEstudiante ? {\n            id: item.estudianteId,\n            nombre: item.nombreEstudiante,\n            matricula: '',\n            email: ''\n          } : undefined,\n          asignatura: item.nombreMateria ? {\n            id: item.materiaId,\n            nombre: item.nombreMateria,\n            codigo: '',\n            creditos: item.creditos || 0,\n            profesorId: item.profesorId || 0,\n            profesor: item.nombreProfesor ? {\n              id: item.profesorId || 0,\n              nombre: item.nombreProfesor,\n              apellido: '',\n              email: '',\n              departamento: '',\n              nombreCompleto: item.nombreProfesor\n            } : undefined\n          } : undefined\n        }));\n      }\n      return [];\n    }), catchError(error => {\n      console.error('Error al obtener inscripciones:', error);\n      return of([]);\n    }));\n  }\n  obtenerInscripcionesAsignatura(asignaturaId) {\n    return this.http.get(`${this.apiUrl}/materia/${asignaturaId}`).pipe(map(respuesta => {\n      console.log('Obteniendo inscripciones para la asignatura:', asignaturaId);\n      if (respuesta && respuesta.exito && respuesta.data) {\n        console.log('Datos de inscripciones obtenidos:', respuesta.data);\n        return respuesta.data.map(item => ({\n          id: item.id,\n          estudianteId: item.estudianteId,\n          asignaturaId: item.materiaId,\n          fechaInscripcion: new Date(item.fechaRegistro),\n          estudiante: item.nombreEstudiante ? {\n            id: item.estudianteId,\n            nombre: item.nombreEstudiante,\n            matricula: '',\n            email: ''\n          } : undefined,\n          asignatura: item.nombreMateria ? {\n            id: item.materiaId,\n            nombre: item.nombreMateria,\n            codigo: '',\n            creditos: item.creditos || 0,\n            profesorId: item.profesorId || 0,\n            profesor: item.nombreProfesor ? {\n              id: item.profesorId || 0,\n              nombre: item.nombreProfesor,\n              apellido: '',\n              email: '',\n              departamento: '',\n              nombreCompleto: item.nombreProfesor\n            } : undefined\n          } : undefined\n        }));\n      }\n      return [];\n    }), catchError(error => {\n      console.error('Error al obtener inscripciones de asignatura:', error);\n      return of([]);\n    }));\n  }\n  obtenerInscripcion(id) {\n    return this.http.get(`${this.apiUrl}/${id}`).pipe(map(respuesta => {\n      if (respuesta && respuesta.exito && respuesta.data) {\n        const item = respuesta.data;\n        return {\n          id: item.id,\n          estudianteId: item.estudianteId,\n          nombreEstudiante: item.nombreEstudiante,\n          materiaId: item.materiaId,\n          nombreMateria: item.nombreMateria,\n          creditos: item.creditos || 0,\n          nombreProfesor: item.nombreProfesor,\n          fechaRegistro: item.fechaRegistro\n        };\n      }\n      throw new Error('Inscripción no encontrada');\n    }), catchError(error => {\n      console.error('Error al obtener inscripción:', error);\n      return throwError(() => new Error('Error al obtener inscripción'));\n    }));\n  }\n  inscribirAsignatura(solicitud) {\n    const estudianteId = solicitud.estudianteId;\n    return this.obtenerInscripcionesEstudiante(estudianteId).pipe(switchMap(inscripciones => {\n      if (inscripciones.length >= this.MAX_ASIGNATURAS) {\n        return throwError(() => new Error('No puedes inscribirte en más de 3 asignaturas'));\n      }\n      const asignaturasRegistradasIds = inscripciones.map(i => i.materiaId);\n      // Usar materiaId si está disponible, de lo contrario usar asignaturaId\n      const materiaIdToCheck = solicitud.materiaId || solicitud.asignaturaId;\n      if (asignaturasRegistradasIds.includes(materiaIdToCheck)) {\n        return throwError(() => new Error('Ya estás inscrito en esta asignatura'));\n      }\n      if (asignaturasRegistradasIds.length === 0) {\n        const solicitudBackend = {\n          estudianteId: solicitud.estudianteId,\n          nombreEstudiante: solicitud.nombreEstudiante || '',\n          materiaId: solicitud.materiaId,\n          nombreMateria: solicitud.nombreMateria || '',\n          creditos: 0,\n          nombreProfesor: null,\n          fechaRegistro: new Date().toISOString()\n        };\n        return this.http.post(this.apiUrl, solicitudBackend).pipe(map(respuesta => {\n          if (respuesta && respuesta.exito && respuesta.data) {\n            const item = respuesta.data;\n            return {\n              id: item.id,\n              estudianteId: item.estudianteId,\n              asignaturaId: item.materiaId,\n              fechaInscripcion: new Date(item.fechaRegistro),\n              estudiante: item.nombreEstudiante ? {\n                id: item.estudianteId,\n                nombre: item.nombreEstudiante,\n                matricula: '',\n                correo: ''\n              } : undefined,\n              asignatura: item.nombreMateria ? {\n                id: item.materiaId,\n                nombre: item.nombreMateria,\n                codigo: '',\n                creditos: item.creditos || 0,\n                profesorId: 0\n              } : undefined\n            };\n          }\n          throw new Error('Error al registrar la asignatura');\n        }), catchError(error => {\n          console.error('Error al inscribir asignatura:', error);\n          return throwError(() => new Error('Error al inscribir asignatura'));\n        }));\n      }\n      return this.asignaturaServicio.obtenerAsignatura(solicitud.materiaId || solicitud.asignaturaId).pipe(switchMap(nuevaAsignatura => {\n        return this.asignaturaServicio.obtenerAsignaturasPorIds(asignaturasRegistradasIds).pipe(switchMap(asignaturasRegistradas => {\n          const profesoresIds = asignaturasRegistradas.map(a => a.profesorId);\n          if (profesoresIds.includes(nuevaAsignatura.profesorId)) {\n            return throwError(() => new Error('No puedes tener más de una asignatura con el mismo profesor'));\n          }\n          const solicitudBackend = {\n            estudianteId: solicitud.estudianteId,\n            nombreEstudiante: solicitud.nombreEstudiante || '',\n            materiaId: solicitud.asignaturaId,\n            nombreMateria: solicitud.nombreAsignatura || '',\n            fechaRegistro: new Date()\n          };\n          return this.http.post(this.apiUrl, solicitudBackend).pipe(map(respuesta => {\n            if (respuesta && respuesta.exito && respuesta.data) {\n              const item = respuesta.data;\n              return {\n                id: item.id,\n                estudianteId: item.estudianteId,\n                asignaturaId: item.materiaId,\n                fechaInscripcion: new Date(item.fechaRegistro),\n                estudiante: item.nombreEstudiante ? {\n                  id: item.estudianteId,\n                  nombre: item.nombreEstudiante,\n                  matricula: '',\n                  correo: ''\n                } : undefined,\n                asignatura: item.nombreMateria ? {\n                  id: item.materiaId,\n                  nombre: item.nombreMateria,\n                  codigo: '',\n                  creditos: item.creditos || 0,\n                  profesorId: 0\n                } : undefined\n              };\n            }\n            throw new Error('Error al registrar la asignatura');\n          }), catchError(error => {\n            console.error('Error al inscribir asignatura:', error);\n            return throwError(() => new Error('Error al inscribir asignatura'));\n          }));\n        }));\n      }));\n    }));\n  }\n  desinscribirAsignatura(inscripcionId) {\n    return this.http.delete(`${this.apiUrl}/${inscripcionId}`).pipe(map(respuesta => {\n      if (respuesta && respuesta.exito) {\n        return respuesta.data;\n      }\n      throw new Error('Error al eliminar la inscripción');\n    }), catchError(error => {\n      console.error('Error al desinscribir asignatura:', error);\n      return throwError(() => new Error('Error al eliminar la inscripción'));\n    }));\n  }\n  obtenerCompaneros(asignaturaId, estudianteId) {\n    return this.http.get(`${this.apiUrl}/materia/${asignaturaId}`).pipe(map(response => {\n      if (response && response.exito && response.data) {\n        return response.data.filter(item => item.estudianteId !== estudianteId).map(item => ({\n          id: item.estudianteId,\n          nombre: item.nombreEstudiante,\n          matricula: '',\n          email: ''\n        }));\n      }\n      return [];\n    }), catchError(error => {\n      console.error('Error al obtener compañeros:', error);\n      return of([]);\n    }));\n  }\n  registrarAsignatura(solicitud) {\n    return this.inscribirAsignatura(solicitud);\n  }\n  puedeAccederSeccionEstudiante() {\n    return this.autenticacionServicio.obtenerUsuarioActual().pipe(map(user => {\n      // Solo los administradores y profesores pueden acceder a la sección de estudiantes\n      return user?.role === 'admin' || user?.role === 'professor';\n    }), catchError(() => of(false)));\n  }\n  obtenerTotalCreditosEstudiante(estudianteId) {\n    return this.obtenerInscripcionesEstudiante(estudianteId).pipe(map(inscripciones => {\n      if (inscripciones.length === 0) {\n        return 0;\n      }\n      // Calcular el total de créditos directamente de las inscripciones\n      return inscripciones.reduce((total, inscripcion) => {\n        // Verificar si la asignatura y sus créditos están definidos\n        const creditos = inscripcion.creditos || 0;\n        return total + creditos;\n      }, 0);\n    }), catchError(error => {\n      console.error('Error al obtener créditos:', error);\n      return of(0);\n    }));\n  }\n  static {\n    this.ɵfac = function InscripcionServicio_Factory(t) {\n      return new (t || InscripcionServicio)(i0.ɵɵinject(i1.HttpClient), i0.ɵɵinject(i2.AsignaturaServicio), i0.ɵɵinject(i3.AutenticacionServicio));\n    };\n  }\n  static {\n    this.ɵprov = /*@__PURE__*/i0.ɵɵdefineInjectable({\n      token: InscripcionServicio,\n      factory: InscripcionServicio.ɵfac,\n      providedIn: 'root'\n    });\n  }\n}","map":{"version":3,"mappings":"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","names":["throwError","of","catchError","map","switchMap","environment","InscripcionServicio","constructor","http","asignaturaServicio","autenticacionServicio","apiUrl","obtenerInscripcionesEstudiante","estudianteId","console","log","get","pipe","respuesta","exito","data","item","id","asignaturaId","materiaId","fechaInscripcion","Date","fechaRegistro","estudiante","nombreEstudiante","nombre","matricula","email","undefined","asignatura","nombreMateria","codigo","creditos","profesorId","profesor","nombreProfesor","apellido","departamento","nombreCompleto","error","obtenerInscripcionesAsignatura","obtenerInscripcion","Error","inscribirAsignatura","solicitud","inscripciones","length","MAX_ASIGNATURAS","asignaturasRegistradasIds","i","materiaIdToCheck","includes","solicitudBackend","toISOString","post","correo","obtenerAsignatura","nuevaAsignatura","obtenerAsignaturasPorIds","asignaturasRegistradas","profesoresIds","a","nombreAsignatura","desinscribirAsignatura","inscripcionId","delete","obtenerCompaneros","response","filter","registrarAsignatura","puedeAccederSeccionEstudiante","obtenerUsuarioActual","user","role","obtenerTotalCreditosEstudiante","reduce","total","inscripcion","factory","providedIn"],"sourceRoot":"","sources":["C:\\Users\\hansk\\Videos\\frontendsistemacolegio.interrapidisi\\frontendsistemacolegio.interrapidisi\\src\\app\\servicios\\inscripcion.servicio.ts"],"sourcesContent":["import { Injectable } from '@angular/core';\nimport { HttpClient } from '@angular/common/http';\nimport { Observable, throwError, forkJoin, of } from 'rxjs';\nimport { catchError, map, switchMap } from 'rxjs/operators';\nimport { Inscripcion, SolicitudInscripcion } from '../modelos/inscripcion.modelo';\nimport { Asignatura } from '../modelos/asignatura.modelo';\nimport { Estudiante } from '../modelos/estudiante.modelo';\nimport { AsignaturaServicio } from './asignatura.servicio';\nimport { AutenticacionServicio } from './autenticacion.servicio';\nimport { environment } from '../../environments/environment';\n\n@Injectable({\n  providedIn: 'root'\n})\nexport class InscripcionServicio {\n  private apiUrl = `${environment.apiUrl}/Registros`;\n  private MAX_ASIGNATURAS = 3;\n\n  constructor(\n    private http: HttpClient,\n    private asignaturaServicio: AsignaturaServicio,\n    private autenticacionServicio: AutenticacionServicio\n  ) { }\n\n  obtenerInscripcionesEstudiante(estudianteId: number): Observable<Inscripcion[]> {\n    console.log(estudianteId)\n    return this.http.get<any>(`${this.apiUrl}/estudiante/${estudianteId}`)\n      .pipe(\n        map(respuesta => {\n          if (respuesta && respuesta.exito && respuesta.data) {\n            console.log('Procesando inscripciones del estudiante:', respuesta.data);\n            return respuesta.data.map((item: any) => ({\n              id: item.id,\n              estudianteId: item.estudianteId,\n              asignaturaId: item.materiaId,\n              fechaInscripcion: new Date(item.fechaRegistro),\n              estudiante: item.nombreEstudiante ? {\n                id: item.estudianteId,\n                nombre: item.nombreEstudiante,\n                matricula: '',\n                email: ''\n              } : undefined,\n              asignatura: item.nombreMateria ? {\n                id: item.materiaId,\n                nombre: item.nombreMateria,\n                codigo: '',\n                creditos: item.creditos || 0,\n                profesorId: item.profesorId || 0,\n                profesor: item.nombreProfesor ? {\n                  id: item.profesorId || 0,\n                  nombre: item.nombreProfesor,\n                  apellido: '',\n                  email: '',\n                  departamento: '',\n                  nombreCompleto: item.nombreProfesor\n                } : undefined\n              } : undefined\n            }));\n          }\n          return [];\n        }),\n        catchError(error => {\n          console.error('Error al obtener inscripciones:', error);\n          return of([]);\n        })\n      );\n  }\n\n  obtenerInscripcionesAsignatura(asignaturaId: number): Observable<Inscripcion[]> {\n    return this.http.get<any>(`${this.apiUrl}/materia/${asignaturaId}`)\n      .pipe(\n        map(respuesta => {\n          console.log('Obteniendo inscripciones para la asignatura:', asignaturaId);\n          if (respuesta && respuesta.exito && respuesta.data) {\n            console.log('Datos de inscripciones obtenidos:', respuesta.data);\n            return respuesta.data.map((item: any) => ({\n              id: item.id,\n              estudianteId: item.estudianteId,\n              asignaturaId: item.materiaId,\n              fechaInscripcion: new Date(item.fechaRegistro),\n              estudiante: item.nombreEstudiante ? {\n                id: item.estudianteId,\n                nombre: item.nombreEstudiante,\n                matricula: '',\n                email: ''\n              } : undefined,\n              asignatura: item.nombreMateria ? {\n                id: item.materiaId,\n                nombre: item.nombreMateria,\n                codigo: '',\n                creditos: item.creditos || 0,\n                profesorId: item.profesorId || 0,\n                profesor: item.nombreProfesor ? {\n                  id: item.profesorId || 0,\n                  nombre: item.nombreProfesor,\n                  apellido: '',\n                  email: '',\n                  departamento: '',\n                  nombreCompleto: item.nombreProfesor\n                } : undefined\n              } : undefined\n            }));\n          }\n          return [];\n        }),\n        catchError(error => {\n          console.error('Error al obtener inscripciones de asignatura:', error);\n          return of([]);\n        })\n      );\n  }\n\n  obtenerInscripcion(id: number): Observable<Inscripcion> {\n    return this.http.get<any>(`${this.apiUrl}/${id}`)\n      .pipe(\n        map(respuesta => {\n          if (respuesta && respuesta.exito && respuesta.data) {\n            const item = respuesta.data;\n            return {\n              id: item.id,\n              estudianteId: item.estudianteId,\n              nombreEstudiante: item.nombreEstudiante,\n              materiaId: item.materiaId,\n              nombreMateria: item.nombreMateria,\n              creditos: item.creditos || 0,\n              nombreProfesor: item.nombreProfesor,\n              fechaRegistro: item.fechaRegistro\n            };\n          }\n          throw new Error('Inscripción no encontrada');\n        }),\n        catchError(error => {\n          console.error('Error al obtener inscripción:', error);\n          return throwError(() => new Error('Error al obtener inscripción'));\n        })\n      );\n  }\n\n  inscribirAsignatura(solicitud: SolicitudInscripcion): Observable<Inscripcion> {\n    const estudianteId = solicitud.estudianteId;\n    return this.obtenerInscripcionesEstudiante(estudianteId).pipe(\n      switchMap(inscripciones => {\n        if (inscripciones.length >= this.MAX_ASIGNATURAS) {\n          return throwError(() => new Error('No puedes inscribirte en más de 3 asignaturas'));\n        }\n        const asignaturasRegistradasIds = inscripciones.map(i => i.materiaId);\n        // Usar materiaId si está disponible, de lo contrario usar asignaturaId\n        const materiaIdToCheck = solicitud.materiaId || solicitud.asignaturaId;\n        if (asignaturasRegistradasIds.includes(materiaIdToCheck)) {\n          return throwError(() => new Error('Ya estás inscrito en esta asignatura'));\n        }\n        if (asignaturasRegistradasIds.length === 0) {\n          const solicitudBackend = {\n            estudianteId: solicitud.estudianteId,\n            nombreEstudiante: solicitud.nombreEstudiante || '',\n            materiaId: solicitud.materiaId,\n            nombreMateria: solicitud.nombreMateria || '',\n            creditos: 0,\n            nombreProfesor: null,\n            fechaRegistro: new Date().toISOString()\n          };\n          return this.http.post<any>(this.apiUrl, solicitudBackend)\n            .pipe(\n              map(respuesta => {\n                if (respuesta && respuesta.exito && respuesta.data) {\n                  const item = respuesta.data;\n                  return {\n                    id: item.id,\n                    estudianteId: item.estudianteId,\n                    asignaturaId: item.materiaId,\n                    fechaInscripcion: new Date(item.fechaRegistro),\n                    estudiante: item.nombreEstudiante ? {\n                      id: item.estudianteId,\n                      nombre: item.nombreEstudiante,\n                      matricula: '',\n                      correo: ''\n                    } : undefined,\n                    asignatura: item.nombreMateria ? {\n                      id: item.materiaId,\n                      nombre: item.nombreMateria,\n                      codigo: '',\n                      creditos: item.creditos || 0,\n                      profesorId: 0\n                    } : undefined\n                  };\n                }\n                throw new Error('Error al registrar la asignatura');\n              }),\n              catchError(error => {\n                console.error('Error al inscribir asignatura:', error);\n                return throwError(() => new Error('Error al inscribir asignatura'));\n              })\n            );\n        }\n        return this.asignaturaServicio.obtenerAsignatura(solicitud.materiaId || solicitud.asignaturaId).pipe(\n          switchMap(nuevaAsignatura => {\n            return this.asignaturaServicio.obtenerAsignaturasPorIds(asignaturasRegistradasIds).pipe(\n              switchMap(asignaturasRegistradas => {\n                const profesoresIds = asignaturasRegistradas.map(a => a.profesorId);\n                if (profesoresIds.includes(nuevaAsignatura.profesorId)) {\n                  return throwError(() => new Error('No puedes tener más de una asignatura con el mismo profesor'));\n                }\n                const solicitudBackend = {\n                  estudianteId: solicitud.estudianteId,\n                  nombreEstudiante: solicitud.nombreEstudiante || '',\n                  materiaId: solicitud.asignaturaId,\n                  nombreMateria: solicitud.nombreAsignatura || '',\n                  fechaRegistro: new Date()\n                };\n                return this.http.post<any>(this.apiUrl, solicitudBackend)\n                  .pipe(\n                    map(respuesta => {\n                      if (respuesta && respuesta.exito && respuesta.data) {\n                        const item = respuesta.data;\n                        return {\n                          id: item.id,\n                          estudianteId: item.estudianteId,\n                          asignaturaId: item.materiaId,\n                          fechaInscripcion: new Date(item.fechaRegistro),\n                          estudiante: item.nombreEstudiante ? {\n                            id: item.estudianteId,\n                            nombre: item.nombreEstudiante,\n                            matricula: '',\n                            correo: ''\n                          } : undefined,\n                          asignatura: item.nombreMateria ? {\n                            id: item.materiaId,\n                            nombre: item.nombreMateria,\n                            codigo: '',\n                            creditos: item.creditos || 0,\n                            profesorId: 0\n                          } : undefined\n                        };\n                      }\n                      throw new Error('Error al registrar la asignatura');\n                    }),\n                    catchError(error => {\n                      console.error('Error al inscribir asignatura:', error);\n                      return throwError(() => new Error('Error al inscribir asignatura'));\n                    })\n                  );\n              })\n            );\n          })\n        );\n      })\n    );\n  }\n\n  desinscribirAsignatura(inscripcionId: number): Observable<any> {\n    return this.http.delete<any>(`${this.apiUrl}/${inscripcionId}`)\n      .pipe(\n        map(respuesta => {\n          if (respuesta && respuesta.exito) {\n            return respuesta.data;\n          }\n          throw new Error('Error al eliminar la inscripción');\n        }),\n        catchError(error => {\n          console.error('Error al desinscribir asignatura:', error);\n          return throwError(() => new Error('Error al eliminar la inscripción'));\n        })\n      );\n  }\n\n  obtenerCompaneros(asignaturaId: number, estudianteId: number): Observable<Estudiante[]> {\n    return this.http.get<any>(`${this.apiUrl}/materia/${asignaturaId}`)\n      .pipe(\n        map(response => {\n          if (response && response.exito && response.data) {\n            return response.data\n              .filter((item: any) => item.estudianteId !== estudianteId)\n              .map((item: any) => ({\n                id: item.estudianteId,\n                nombre: item.nombreEstudiante,\n                matricula: '',\n                email: ''\n              }));\n          }\n          return [];\n        }),\n        catchError(error => {\n          console.error('Error al obtener compañeros:', error);\n          return of([]);\n        })\n      );\n  }\n\n  registrarAsignatura(solicitud: SolicitudInscripcion): Observable<Inscripcion> {\n    return this.inscribirAsignatura(solicitud);\n  }\n\n  puedeAccederSeccionEstudiante(): Observable<boolean> {\n    return this.autenticacionServicio.obtenerUsuarioActual().pipe(\n      map(user => {\n        // Solo los administradores y profesores pueden acceder a la sección de estudiantes\n        return user?.role === 'admin' || user?.role === 'professor';\n      }),\n      catchError(() => of(false))\n    );\n  }\n\n  obtenerTotalCreditosEstudiante(estudianteId: number): Observable<number> {\n    return this.obtenerInscripcionesEstudiante(estudianteId).pipe(\n      map(inscripciones => {\n        if (inscripciones.length === 0) {\n          return 0;\n        }\n        \n        // Calcular el total de créditos directamente de las inscripciones\n        return inscripciones.reduce((total, inscripcion) => {\n          // Verificar si la asignatura y sus créditos están definidos\n          const creditos = inscripcion.creditos || 0;\n          return total + creditos;\n        }, 0);\n      }),\n      catchError(error => {\n        console.error('Error al obtener créditos:', error);\n        return of(0);\n      })\n    );\n  }\n}"]},"metadata":{},"sourceType":"module","externalDependencies":[]}